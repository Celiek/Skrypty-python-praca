2025-09-04 12:48:29,267 [INFO] loader:326 - Start wczytywania pliku: clickup_tasks_clean3.xlsx
2025-09-04 12:48:29,778 [INFO] loader:331 - Wczytano arkusz: 1441 wierszy, 44 kolumn
2025-09-04 12:48:29,818 [DEBUG] loader:333 - Kolumny po czyszczeniu: ['ID', 'Nazwa', 'Status', 'Opis', 'Data utworzenia', 'Data aktualizacji', 'Przypisani', 'Category', 'Regulations accept', 'Merchant Group', 'Base. Account Type', 'Merchant mail', 'NIP', 'Merchant ID', 'Merchant Adres', 'Merchant Mail FV', 'Produkty Merchanta', 'Return Adres', 'Telefon', 'Website', 'Next Meeting Date:', 'Held first meeting', 'StatusBar Shortcut', 'Mail warunki', 'Warunki', 'Main Category', 'Merchant BL ID', 'Merchant KAM', 'Regulations email date sent', 'Merchant Information Form', 'SM Bestsellers upload', 'Merchant KAM (link)', 'Regulations accept date', 'Regulations Accept Relation', 'AVG Sent -> Accept', 'Listing ready Date', 'AVG Sent -> Listing', 'AVG Accept -> Listing', 'Akceptacja Regulaminu', 'SYNC WITH SM', 'relation_status', 'Price Check', 'Podmiana nazwy', 'Price Check fail Mail']
2025-09-04 12:48:30,099 [INFO] loader:380 - Znormalizowano: 1441 wierszy, 28 kolumn
2025-09-04 12:48:30,230 [INFO] loader:271 - DIAG: brak oczywistych problemów typów w DF.
2025-09-04 12:48:31,143 [INFO] loader:548 - Wiersze z ustawionym relation_status: 1361
2025-09-04 12:48:31,145 [INFO] loader:556 - Próbka po UPSERCIE: [{'id': '86c1q4ztg', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q529h', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q5b48', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q5urg', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q65wk', 'status': 'merchant', 'relation_status': 13}]
2025-09-04 12:48:31,147 [INFO] loader:559 - KONIEC: 1.88 s (wierszy wejściowych: 1441)
2025-09-04 12:48:31,154 [ERROR] loader:47 - Unhandled exception
Traceback (most recent call last):
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "ux_merchanci_nip_notnull"
DETAIL:  Key (nip)=(5213913595) already exists.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\DELL\Desktop\skrypty\docker_baza\app\main.py", line 610, in <module>
    wczytaj_plik()
    ~~~~~~~~~~~~^^
  File "C:\Users\DELL\Desktop\skrypty\docker_baza\app\main.py", line 606, in wczytaj_plik
    con.execute(sql)
    ~~~~~~~~~~~^^^^^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "ux_merchanci_nip_notnull"
DETAIL:  Key (nip)=(5213913595) already exists.

[SQL: 
WITH ranked AS (
  SELECT
    s.*,
    ROW_NUMBER() OVER (
      PARTITION BY s.nip
      ORDER BY
        s.regulations_acceptance_date DESC NULLS LAST,
        s.regulations_email_date_sent DESC NULLS LAST,
        s.data_utworzenia DESC NULLS LAST,
        s.id DESC
    ) AS rn
  FROM merchanci_staging s
  WHERE s.nip IS NOT NULL
)
INSERT INTO merchanci AS m (
  id, nazwa, status, opis, data_utworzenia, przypisani, category,
  regulations_acceptance, merchant_group, base_account_type, merchant_mail,
  nip, merchant_id, merchant_adres, merchant_mail_fv, produkty_merchant,
  return_adres, telefon_merchant, website_merchant, status_bar_shortcut,
  mail_warunki, warunki_akceptacja, main_category, merchant_bl_id,
  merchant_kam, regulations_email_date_sent, regulations_acceptance_date,
  relation_status
)
SELECT
  r.id, r.nazwa, r.status, r.opis, r.data_utworzenia, r.przypisani, r.category,
  r.regulations_acceptance, r.merchant_group, r.base_account_type, r.merchant_mail,
  r.nip, r.merchant_id, r.merchant_adres, r.merchant_mail_fv, r.produkty_merchant,
  r.return_adres, r.telefon_merchant, r.website_merchant, r.status_bar_shortcut,
  r.mail_warunki, r.warunki_akceptacja, r.main_category, r.merchant_bl_id,
  r.merchant_kam, r.regulations_email_date_sent, r.regulations_acceptance_date,
  r.relation_status
FROM ranked r
WHERE r.rn = 1
ON CONFLICT (nip,id) DO NOTHING ;
]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-09-04 13:06:29,718 [INFO] loader:326 - Start wczytywania pliku: clickup_tasks_clean3.xlsx
2025-09-04 13:06:30,251 [INFO] loader:331 - Wczytano arkusz: 1441 wierszy, 44 kolumn
2025-09-04 13:06:30,289 [DEBUG] loader:333 - Kolumny po czyszczeniu: ['ID', 'Nazwa', 'Status', 'Opis', 'Data utworzenia', 'Data aktualizacji', 'Przypisani', 'Category', 'Regulations accept', 'Merchant Group', 'Base. Account Type', 'Merchant mail', 'NIP', 'Merchant ID', 'Merchant Adres', 'Merchant Mail FV', 'Produkty Merchanta', 'Return Adres', 'Telefon', 'Website', 'Next Meeting Date:', 'Held first meeting', 'StatusBar Shortcut', 'Mail warunki', 'Warunki', 'Main Category', 'Merchant BL ID', 'Merchant KAM', 'Regulations email date sent', 'Merchant Information Form', 'SM Bestsellers upload', 'Merchant KAM (link)', 'Regulations accept date', 'Regulations Accept Relation', 'AVG Sent -> Accept', 'Listing ready Date', 'AVG Sent -> Listing', 'AVG Accept -> Listing', 'Akceptacja Regulaminu', 'SYNC WITH SM', 'relation_status', 'Price Check', 'Podmiana nazwy', 'Price Check fail Mail']
2025-09-04 13:06:30,578 [INFO] loader:380 - Znormalizowano: 1441 wierszy, 28 kolumn
2025-09-04 13:06:30,701 [INFO] loader:271 - DIAG: brak oczywistych problemów typów w DF.
2025-09-04 13:06:31,610 [INFO] loader:548 - Wiersze z ustawionym relation_status: 1361
2025-09-04 13:06:31,612 [INFO] loader:556 - Próbka po UPSERCIE: [{'id': '86c1q4ztg', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q529h', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q5b48', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q5urg', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q65wk', 'status': 'merchant', 'relation_status': 13}]
2025-09-04 13:06:31,613 [INFO] loader:559 - KONIEC: 1.89 s (wierszy wejściowych: 1441)
2025-09-04 13:06:31,624 [ERROR] loader:47 - Unhandled exception
Traceback (most recent call last):
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.InvalidColumnReference: there is no unique or exclusion constraint matching the ON CONFLICT specification


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\DELL\Desktop\skrypty\docker_baza\app\main.py", line 610, in <module>
    wczytaj_plik()
    ~~~~~~~~~~~~^^
  File "C:\Users\DELL\Desktop\skrypty\docker_baza\app\main.py", line 606, in wczytaj_plik
    con.execute(sql)
    ~~~~~~~~~~~^^^^^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\DELL\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.InvalidColumnReference) there is no unique or exclusion constraint matching the ON CONFLICT specification

[SQL: 
WITH ranked AS (
  SELECT
    s.*,
    ROW_NUMBER() OVER (
      PARTITION BY s.nip
      ORDER BY
        s.regulations_acceptance_date DESC NULLS LAST,
        s.regulations_email_date_sent DESC NULLS LAST,
        s.data_utworzenia DESC NULLS LAST,
        s.id DESC
    ) AS rn
  FROM merchanci_staging s
  WHERE s.nip IS NOT NULL
)
INSERT INTO merchanci AS m (
  id, nazwa, status, opis, data_utworzenia, przypisani, category,
  regulations_acceptance, merchant_group, base_account_type, merchant_mail,
  nip, merchant_id, merchant_adres, merchant_mail_fv, produkty_merchant,
  return_adres, telefon_merchant, website_merchant, status_bar_shortcut,
  mail_warunki, warunki_akceptacja, main_category, merchant_bl_id,
  merchant_kam, regulations_email_date_sent, regulations_acceptance_date,
  relation_status
)
SELECT
  r.id, r.nazwa, r.status, r.opis, r.data_utworzenia, r.przypisani, r.category,
  r.regulations_acceptance, r.merchant_group, r.base_account_type, r.merchant_mail,
  r.nip, r.merchant_id, r.merchant_adres, r.merchant_mail_fv, r.produkty_merchant,
  r.return_adres, r.telefon_merchant, r.website_merchant, r.status_bar_shortcut,
  r.mail_warunki, r.warunki_akceptacja, r.main_category, r.merchant_bl_id,
  r.merchant_kam, r.regulations_email_date_sent, r.regulations_acceptance_date,
  r.relation_status
FROM ranked r
WHERE r.rn = 1
ON CONFLICT (id,nip) DO NOTHING ;
]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-09-04 13:08:08,413 [INFO] loader:326 - Start wczytywania pliku: clickup_tasks_clean3.xlsx
2025-09-04 13:08:08,914 [INFO] loader:331 - Wczytano arkusz: 1441 wierszy, 44 kolumn
2025-09-04 13:08:08,958 [DEBUG] loader:333 - Kolumny po czyszczeniu: ['ID', 'Nazwa', 'Status', 'Opis', 'Data utworzenia', 'Data aktualizacji', 'Przypisani', 'Category', 'Regulations accept', 'Merchant Group', 'Base. Account Type', 'Merchant mail', 'NIP', 'Merchant ID', 'Merchant Adres', 'Merchant Mail FV', 'Produkty Merchanta', 'Return Adres', 'Telefon', 'Website', 'Next Meeting Date:', 'Held first meeting', 'StatusBar Shortcut', 'Mail warunki', 'Warunki', 'Main Category', 'Merchant BL ID', 'Merchant KAM', 'Regulations email date sent', 'Merchant Information Form', 'SM Bestsellers upload', 'Merchant KAM (link)', 'Regulations accept date', 'Regulations Accept Relation', 'AVG Sent -> Accept', 'Listing ready Date', 'AVG Sent -> Listing', 'AVG Accept -> Listing', 'Akceptacja Regulaminu', 'SYNC WITH SM', 'relation_status', 'Price Check', 'Podmiana nazwy', 'Price Check fail Mail']
2025-09-04 13:08:09,229 [INFO] loader:380 - Znormalizowano: 1441 wierszy, 28 kolumn
2025-09-04 13:08:09,350 [INFO] loader:271 - DIAG: brak oczywistych problemów typów w DF.
2025-09-04 13:08:10,251 [INFO] loader:548 - Wiersze z ustawionym relation_status: 1361
2025-09-04 13:08:10,254 [INFO] loader:556 - Próbka po UPSERCIE: [{'id': '86c1q4ztg', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q529h', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q5b48', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q5urg', 'status': 'merchant', 'relation_status': 13}, {'id': '86c1q65wk', 'status': 'merchant', 'relation_status': 13}]
2025-09-04 13:08:10,255 [INFO] loader:559 - KONIEC: 1.84 s (wierszy wejściowych: 1441)
